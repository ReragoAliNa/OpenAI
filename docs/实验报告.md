# OpenAI 捉迷藏系统复现实验报告

## 1. 实验目的
本实验旨在复现 OpenAI 的 Multi-Agent Hide and Seek (捉迷藏) 环境，通过运行预训练的策略模型，观察多智能体在复杂环境中的协作与其涌现出的工具使用行为。

## 2. 实验环境
- **操作系统**: Windows
- **代码库**: 
    - `multi-agent-emergence-environments`
    - `mujoco-worldgen`
- **依赖库**: MuJoCo, NumPy, Gym 等 (详见 requirements.txt)

## 3. 实验步骤
1.  **环境配置**:
    - **MuJoCo Py 配置**: 修改 `mujoco-worldgen/requirements.txt`，移除 `scipy`, `jsonnet`, `mujoco-py` 的版本锁定，以便在 Python 3.10 环境下安装。
    - **依赖安装**:
        - 运行 `pip install -r mujoco-worldgen/requirements.txt`
        - 运行 `pip install -e mujoco-worldgen/`
        - 修改 `multi-agent-emergence-environments/requirements_ma_policy.txt`，移除版本锁定。
        - 运行 `pip install -r multi-agent-emergence-environments/requirements_ma_policy.txt`
        - 运行 `pip install -e multi-agent-emergence-environments/`
    - **MuJoCo 二进制文件**: 系统检测到缺少 `mujoco210`，需要用户手动下载并解压至 `C:\Users\33587\.mujoco\mujoco210`。
2.  **模型运行**:
    - 进入 `multi-agent-emergence-environments` 目录。
    - 执行命令: `python bin/examine.py examples/hide_and_seek_quadrant.jsonnet examples/hide_and_seek_quadrant.npz`

## 4. 实验结果

### 4.1 环境配置过程
在配置实验环境时遇到了多个兼容性问题：

1. **Python 版本兼容性**: 
   - 使用 Python 3.9 (`ma_env` 环境)
   - 原始要求文件中的依赖版本过旧，需要移除版本锁定

2. **MuJoCo 配置**:
   - 下载并安装 MuJoCo 2.1.0 到 `C:\Users\33587\.mujoco\mujoco210\`
   - 需要在 Python 脚本中添加 DLL 路径：`os.add_dll_directory("C://Users//33587//.mujoco//mujoco210//bin")`
   - 需要在 PowerShell 中设置环境变量：`$env:PATH = "C:\Users\33587\.mujoco\mujoco210\bin;" + $env:PATH`

3. **NumPy 兼容性**:
   - 降级 NumPy 到 1.23.5 以兼容 `mujoco-py`

4. **TensorFlow 兼容性问题** ⚠️:
   - 安装的 `baselines==0.1.5` 与 TensorFlow 2.x 不兼容
   - TensorFlow 1.15 在 Python 3.9 上不可用
   - **当前状态**: 环境配置接近完成，但需要解决 TensorFlow 版本兼容性问题

### 4.2 解决方案建议
为了成功运行该实验，建议采用以下方案之一：

**方案 A**: 使用 Python 3.7 + TensorFlow 1.15
- 创建新的 conda 环境：`conda create -n openai_hide python=3.7`
- 安装 TensorFlow 1.15.0 和原始版本的依赖

**方案 B**: 修改 baselines 库的代码
- 将 `tf.float32` 替换为 `tf.dtypes.float32`
- 适配其他 TensorFlow 2.x 的 API 变更

**方案 C**: 使用预编译的 Docker 容器
- 使用官方提供的运行环境（如果有）

### 4.3 已完成的工作
✅ 成功安装 `mujoco-worldgen` 和 `multi-agent-emergence-environments`  
✅ 成功配置 MuJoCo 2.1.0 物理引擎  
✅ 解决 NumPy、SciPy 等依赖的版本冲突  
✅ 修改 `bin/examine.py` 以正确加载 MuJoCo DLL  
⏳ TensorFlow 与 baselines 的兼容性问题待解决

## 5. 结论与建议

### 5.1 遇到的核心问题
本次实验复现过程中遇到的主要挑战是**软件依赖的版本兼容性问题**：

1. **基础环境问题**：
   - 原项目设计于 2019 年，使用 Python 3.6/3.7 + TensorFlow 1.15
   - 现代环境（Python 3.9+）无法直接安装 TensorFlow 1.15
   
2. **TensorFlow 兼容性**：
   - `baselines==0.1.5` 库严格依赖 TensorFlow 1.x API
   - TensorFlow 2.x 的 API 变更（如 `tf.Session` 被移除）导致无法直接兼容
   - 尝试使用 TensorFlow 2.12 并修改 baselines 代码，但 API 差异过大

3. **NumPy 版本冲突**：
   - `mujoco-py` 需要 NumPy < 2.0
   - TensorFlow 2.20 需要 NumPy >= 2.0
   - 无法同时满足两者的要求

### 5.2 推荐的解决方案

**方案：创建 Python 3.7 专用环境（最可靠）**

```powershell
# 1. 创建 Python 3.7 环境
conda create -n openai_hide_py37 python=3.7

# 2. 激活环境
conda activate openai_hide_py37

# 3. 安装原始版本的依赖
pip install tensorflow==1.15.0
pip install -r mujoco-worldgen/requirements.txt
pip install -r multi-agent-emergence-environments/requirements_ma_policy.txt
pip install -e mujoco-worldgen/
pip install -e multi-agent-emergence-environments/

# 4. 配置 MuJoCo PATH 并运行
$env:PATH = "C:\Users\33587\.mujoco\mujoco210\bin;" + $env:PATH
python bin/examine.py examples/hide_and_seek_quadrant.jsonnet examples/hide_and_seek_quadrant.npz
```

### 5.3 实验价值与收获

尽管未能在当前环境成功运行，但本次实验过程具有重要的学习价值：

1. **深度学习项目的可复现性挑战**：
   - 理解了依赖版本管理的重要性
   - 体验了旧项目迁移到新环境的困难
   
2. **环境配置技能**：
   - 学会了 MuJoCo 物理引擎的配置
   - 掌握了 conda 虚拟环境管理
   - 了解了 Python DLL 加载机制（Windows）

3. **故障排查能力**：
   - 通过系统的错误分析定位问题根源
   - 尝试了多种兼容性解决方案

### 5.4 下一步建议

1. **短期方案**：按照 5.2 节创建 Python 3.7 环境
2. **长期方案**：将整个项目迁移到 TensorFlow 2.x（需要重写 baselines 相关代码）
3. **替代方案**：使用 Docker 容器封装原始运行环境

### 5.5 项目结构理解

通过阅读源代码，已经理解了该项目的核心架构：
- **环境生成**：`mujoco-worldgen` 动态生成物理仿真场景
- **游戏逻辑**：`mae_envs/envs/hide_and_seek.py` 定义奖励、胜负判定
- **智能体策略**：`*.npz` 文件存储预训练的神经网络权重
- **可视化**：`bin/examine.py` 启动 MuJoCo 可视化窗口

### 5.6 环境迁移：WSL2 (成功运行! ✅)
由于 Windows 原生环境的局限性，我们成功在 WSL2 (Ubuntu) 环境中完成了系统复现。

**主要成果：**
1.  **环境部署**：在 WSL2 中安装了 Python 3.7, TensorFlow 1.15.0 和 MuJoCo 2.1.0。
2.  **代码修复**：
    *   修复了 `mujoco-worldgen` 中 `xmltodict` 返回 `dict` 而非 `OrderedDict` 导致的断言失败。
    *   修复了 `ma_policy` 中因为 TensorFlow 符号张量（Symbolic Tensors）无法直接被 NumPy 函数（如 `np.all`, `np.array`, `np.prod`）处理导致的崩溃。
    *   修复了 `entity_concat` 层中因尝试对张量进行切片操作而导致的错误。
3.  **成功启动**：通过 `wsl_run.sh` 成功加载了躲避者（Hiders）和搜索者（Seekers）的预训练模型并启动了仿真。

**实验状态**：项目已在 WSL2 中完全调通，预训练模型加载正常。在有 X11 转发（如 VcXsrv）的环境下可直接看到可视化结果。

---

## 6. 技术限制分析

### 6.1 核心问题总结
经过大量调试和尝试，发现了一个**无法绕过的技术限制**：

**TensorFlow 1.15.0 官方不支持 Windows + Python 3.7 组合**

- TensorFlow 1.15.x 主要为 Linux/macOS 设计
- Windows 版本的 TensorFlow 1.x 最高支持到 1.14，且仅支持 Python 3.5/3.6
- Python 3.7 在 Windows 上只能安装 TensorFlow 2.x（最低 2.0）

### 6.2 依赖冲突分析图

```
OpenAI Hide and Seek 项目依赖关系：
├── baselines==0.1.5 (强制要求)
│   └── TensorFlow 1.x (Session API)
│       └── Python 3.5/3.6/3.7
│           └── ❌ Windows 不支持 TensorFlow 1.15 + Python 3.7
├── mujoco-py
│   └── NumPy < 2.0
└── gym==0.10.8
    └── 需要特定编译环境（Windows 上困难）
```

### 6.3 可行的替代方案

#### 方案 A：使用 Linux 环境（推荐 ⭐⭐⭐⭐⭐）
```bash
# 在 WSL2 或 Linux 虚拟机中
conda create -n openai_hide python=3.6
conda activate openai_hide
pip install tensorflow==1.15.0  # Linux 可用
pip install -r requirements.txt
python bin/examine.py examples/hide_and_seek_quadrant.jsonnet examples/hide_and_seek_quadrant.npz
```

#### 方案 B：使用 Docker（推荐 ⭐⭐⭐⭐）
```dockerfile
FROM python:3.6-slim
RUN pip install tensorflow==1.15.0
# ... 其他依赖
```

#### 方案 C：降级到 Windows Python 3.6 + TensorFlow 1.14
- 可能可行，但 TensorFlow 1.14 API 可能不兼容
- 需要测试

#### 方案 D：完全重写以支持 TensorFlow 2.x
- 工作量巨大
- 需要修改 baselines 库的所有 TensorFlow 1.x API 调用

### 6.4 实验收获

虽然未能成功运行，但通过此次实验获得了宝贵经验：

1. **深度学习项目的平台依赖性**
   - 理解了跨平台兼容性的重要性
   - 认识到 Windows 在深度学习开发中的局限性

2. **版本管理的复杂性**
   - 体验了依赖地狱（Dependency Hell）
   - 学会了如何系统地分析依赖冲突

3. **完整的环境配置流程**
   - MuJoCo 物理引擎配置 ✅
   - Conda 虚拟环境管理 ✅
   - DLL 路径配置 ✅
   - pip 镜像源配置 ✅

4. **问题排查能力**
   - 通过错误日志定位问题
   - 尝试多种解决方案
   - 最终确认技术限制

### 6.5 最终建议

**如果您想成功运行此实验，强烈建议：**

1. **使用 Linux 系统**（Ubuntu 18.04/20.04）
2. **或使用 WSL2**（Windows Subsystem for Linux）
3. **或使用 Docker 容器**

这些环境下可以正常安装 TensorFlow 1.15.0 并运行实验。

### 6.6 项目文件清单

本次实验过程中创建的文件：
- ✅ `实验报告.md` - 完整的实验报告（本文件）
- ✅ `安装指南.md` - 详细的安装步骤
- ✅ `run_with_py37.ps1` - 运行脚本（适用于成功安装后）
- ✅ `patch_baselines.py` - TensorFlow 2兼容性补丁（未成功）
- ✅ `restore_baselines.py` - 恢复脚本

### 6.7 结论

本实验遇到的是**技术架构层面的限制**，而非配置问题。在 Windows 环境下，由于 TensorFlow 官方的平台支持策略，**无法完整复现 2019 年发布的此实验**。

建议采用 **Linux 环境**或 **Docker 容器**来运行此项目。
